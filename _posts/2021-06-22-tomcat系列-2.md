---
layout:     post
title:      tomcat系列-2
subtitle:   tomcat源码
date:       2021-06-22
author:     CodingAndLiving
header-img: img/com01.jpg
catalog: true
tags:
    - tomcat
    - 源码
    - 底层
---
# 前言

> 在繁杂的世界，能够沉下心来，梳理下知识体系，其实是一件很放松的诗意。

其实之前也写过一篇博客，介绍了tomcat的组件，接下来这个新系列，打算从源码角度描述下。希望本人不懒惰，能坚持写下去。

# Tomcat 启动流程

老规矩，从下面这个入口开始看起，
org.apache.catalina.startup.Bootstrap#start

接着看到下面方法

```
  public void start() {

        if (getServer() == null) {
            load();
        }

        if (getServer() == null) {
            log.fatal("Cannot start server. Server instance is not configured.");
            return;
        }

        long t1 = System.nanoTime();

        // Start the new server
        try {
            getServer().start();
        } catch (LifecycleException e) {
            log.fatal(sm.getString("catalina.serverStartFail"), e);
            try {
                getServer().destroy();
            } catch (LifecycleException e1) {
                log.debug("destroy() failed for failed Server ", e1);
            }
            return;
        }

        long t2 = System.nanoTime();
        if(log.isInfoEnabled()) {
            log.info("Server startup in " + ((t2 - t1) / 1000000) + " ms");
        }

        // Register shutdown hook
        if (useShutdownHook) {
            if (shutdownHook == null) {
                shutdownHook = new CatalinaShutdownHook();
            }
            Runtime.getRuntime().addShutdownHook(shutdownHook);

            // If JULI is being used, disable JULI's shutdown hook since
            // shutdown hooks run in parallel and log messages may be lost
            // if JULI's hook completes before the CatalinaShutdownHook()
            LogManager logManager = LogManager.getLogManager();
            if (logManager instanceof ClassLoaderLogManager) {
                ((ClassLoaderLogManager) logManager).setUseShutdownHook(
                        false);
            }
        }

        if (await) {
            await();
            stop();
        }
    }

```


1. 首先来看看，await方法里面的一个小动作，

 ```
 boolean match = command.toString().equals(shutdown);
                if (match) {
                    log.info(sm.getString("standardServer.shutdownViaPort"));
                    break;
                }
```

这是指我们配置文件里面


`<Server port="8005" shutdown="SHUTDOWN">`

这里配置的shutdown的值，其实可以实现关机效果，所以一般部署时候，处于安全考虑，会给该值进行修改。



2. 下面看看server的start方法

org.apache.catalina.core.StandardServer#startInternal

接着看看Service的start方法，这里面就丰富了
```

 @Override
    protected void startInternal() throws LifecycleException {

        if(log.isInfoEnabled())
            log.info(sm.getString("standardService.start.name", this.name));
        setState(LifecycleState.STARTING);

        // Start our defined Container first
        if (engine != null) {
            synchronized (engine) {
                engine.start();
            }
        }

        synchronized (executors) {
            for (Executor executor: executors) {
                executor.start();
            }
        }

        mapperListener.start();

        // Start our defined Connectors second
        synchronized (connectorsLock) {
            for (Connector connector: connectors) {
                try {
                    // If it has already failed, don't try and start it
                    if (connector.getState() != LifecycleState.FAILED) {
                        connector.start();
                    }
                } catch (Exception e) {
                    log.error(sm.getString(
                            "standardService.connector.startFailed",
                            connector), e);
                }
            }
        }
    }


```

	1. 先来看看engine的启动方法，这个是继承父类的  org.apache.catalina.core.ContainerBase#startInternal

其实包括背后的容器，例如host，context等，start的方法也是很类似。


好了，启动流程，暂告一段落，下面看看热加载热部署，以及tomcat处理请求专题

# Tomcat 热部署流程

# Tomcat 处理请求专题